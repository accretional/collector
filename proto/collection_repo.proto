// collection_repo.proto
syntax = "proto3";

package collector;
option go_package = "github.com/accretional/collector/gen/collector";

import "common.proto";
import "collection.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/any.proto"; // <--- ADDED THIS IMPORT

// ============================================================================
// CollectionRepo Service
// Maintains a Collection of Collections
// Provides discovery, routing, and cross-collection search
// ============================================================================

message CreateCollectionRequest {
  Collection collection = 1;
}

message CreateCollectionResponse {
  Status status = 1;
  string collection_id = 2;
  string server_endpoint = 3;
}

message DiscoverRequest {
  string namespace = 1;  // Empty for all
  map<string, string> label_filter = 2;
  MessageTypeRef message_type_filter = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message DiscoverResponse {
  Status status = 1;
  repeated Collection collections = 2;
  string next_page_token = 3;
}

message RouteRequest {
  NamespacedName collection = 1;
}

message RouteResponse {
  Status status = 1;
  string server_endpoint = 2;
  Collection collection = 3;
}

// Search across multiple collections
message SearchCollectionsRequest {
  string namespace = 1;
  repeated string collection_names = 2;
  // Empty for all
  google.protobuf.Struct query = 3;
  int32 limit = 4;
  string order_by = 5;
}

message SearchCollectionsResponse {
  message CollectionResult {
    string collection_name = 1;
    repeated google.protobuf.Any items = 2;
    map<string, double> scores = 3;
  }

  Status status = 1;
  repeated CollectionResult results = 2;
  int64 total_matches = 3;
}

// Clone a collection to another collector or location
message CloneRequest {
  NamespacedName source_collection = 1;
  string dest_namespace = 2;
  string dest_name = 3;
  string dest_endpoint = 4;  // Optional: remote collector endpoint
  bool include_files = 5;     // Include filesystem data
}

message CloneResponse {
  Status status = 1;
  string collection_id = 2;
  int64 records_cloned = 3;
  int64 files_cloned = 4;
  int64 bytes_transferred = 5;
}

// Fetch a collection from a remote collector
message FetchRequest {
  string source_endpoint = 1;  // Remote collector endpoint
  NamespacedName source_collection = 2;
  string dest_namespace = 3;   // Local namespace to create collection in
  string dest_name = 4;        // Local name for collection
  bool include_files = 5;      // Include filesystem data
}

message FetchResponse {
  Status status = 1;
  string collection_id = 2;
  int64 records_fetched = 3;
  int64 files_fetched = 4;
  int64 bytes_transferred = 5;
}

service CollectionRepo {
  rpc CreateCollection(CreateCollectionRequest) returns (CreateCollectionResponse);
  rpc Discover(DiscoverRequest) returns (DiscoverResponse);
  rpc Route(RouteRequest) returns (RouteResponse);
  rpc SearchCollections(SearchCollectionsRequest) returns (SearchCollectionsResponse);
  rpc Clone(CloneRequest) returns (CloneResponse);
  rpc Fetch(FetchRequest) returns (FetchResponse);
}
